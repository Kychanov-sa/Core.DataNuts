# Core.DataNuts

Орех данных (data nut) - формализованный формат хранения данных в нетипизированных хранилищах по типу хранилищ blob-объектов.
Орех состоит из ядра (core), представляющего хранимые данные, и заголовка, который обеспечивает типизацию и идентификацию данных.
Перед отправкой данных на хранение в нетипизированное хранилище, данные упаковываются в орех, что позволяет сохранить исходную информацию о типе данных,
метаинформацию о них, а также однозначно идентифицировать данные в хранилище для дедупликации.

## Структура ореха данных

### Версия 1.0

Орех данных имеет бинарный формат со следующей структурой:
```
<DataNutHeader(32 bytes)>
<CoreData(...)>
```

**DataNutHeader** - заголовок, описывающий хранимые в орехе данные.
**CoreData** - хранимые данные в оригинальном виде.

#### Заголовок DataNutHeader

Заголовок ореха - это структура размером 32 байта, состоящая из следующих полей:

|Тип|Смещение|Имя поля|Описание|
|---|---|--------|--------|
|DWORD|0|Signature|Сигнатура ореха|
|WORD|4|Version|Версия структуры данных ореха. Имеет значение 0x0100|
|QWORD|6|Created|Дата создания ореха|
|GUID|12|Id|Идентификатор ореха, определяемый хранимыми данными|
|QWORD|12|CoreHash|Значение хэша ядра ореха|
|DWORD|20|CoreSize|Размер ядра ореха в байтах|
|DWORD|24|CoreType|Тип данных, хранимых в ядре ореха|
|DWORD|28|CoreOffset|Смещение до данных ядра в орехе|

Поясления к полям:
 * Signature - сигнатура представляет собой последовательность байт в виде ASCII символов `C`,`F`,`D`,`N`.
 * Version - для версии 1.0 значение этого поля равно 0x0100.
 * Created - значение этого свойства представляет количество 100-наносекундных интервалов, прошедших с 12:00:00 полуночи 1 января 0001 года в григорианском календаре в часовой зоне UTC. Он не включает количество тактов, связанных с високосными секундами.
 * Id - поле идентификатора составное, включает в себя значение хэша ядра ореха, его размер и тип. Фактически идентификатор полностью определяется исходными данными, которые помещаются в орех.
 * CoreHash - для рассчёта хэша ядра используется алгоритм [xxhash64](https://learn.microsoft.com/ru-ru/dotnet/api/system.io.hashing.xxhash64).
 * CoreSize - фактический размер хранимых в орехе даных ограничивается значением 32-битного поля размера, т.е. максимум 4 294 967 295 байт.
 * CoreType - определение типа данных, хранимых в орехе описывается в разделе ниже.

За блоком DataNutHeader следуют непосредственно данные ядра ореха.

#### Тип данных ядра ореха

Тип данных, хранимых в орехе определяется 32-битным полем CoreType.
Значение типа следует трактовать так:
 * если старший бит старшего байта значения не установлен, то значение представляет собой 4 ASCII символа, формирующие расширение соответствующего файла с данным типом контента в файловой системе;
 * если старший бит старшего байта значения установлен, то значение представляет собой перечисление типа из стандартного списка.

|Значение типа|Тип данных ядра ореха|
|---|--------|
|0x80000000|Неспецифицированные бинарные данные|
|0x80000001|Неспецифицированные текстовые данные|
|0x80000002|Текстовые данные в кодировке UTF-8|

### Версия 1.1

Версия 1.1 расширяет формат хранения ореха, добавляя блок с метаинформацией.

Структура данных ореха версии 1.1 имеет следующий вид:
```
<DataNutHeader>
[Metadata]
<CoreData>
```

Значение Version в заголовке DataNutHeader имеет значение 0x0110.
Размер блока метаданных определяется как разницы между значением CoreOffset и размером структуры DataNutHeader:
```csharp
uint32 metadataSize = header.CoreOffset - sizeof(DataNutHeader);
```

Версия 1.1 является обратно совместимой с версией 1.0.

#### Блок метаданных

Блок метаданных представляет собой последовательность UTF-8 строк в виде пар ""ключ:значение", разделённых символом переноса строки (\n).

Пример содержимого блока метаинформации:
```
Author:John Dow
Origin:Google Docs
Copyrights:2003 John Dow
```

